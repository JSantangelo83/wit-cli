#!/bin/bash

wit_yaml="./wit.yaml"

check_dependencies() {
    local missing=()
    local dependencies=("yq")

    for cmd in "${dependencies[@]}"; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing+=("$cmd")
        fi
    done

    if [ "${#missing[@]}" -gt 0 ]; then
        echo "[-] The following required command(s) are missing:"
        for cmd in "${missing[@]}"; do
            echo "  - $cmd"
        done
        echo "[-] Please install them and try again."
        exit 1
    fi
}

get_port() {
    while :; do
        port=$(shuf -i 2000-65000 -n 1)
        if ! ss -tuln | awk '{print $5}' | grep -q ":$port\$"; then
            echo "$port"
            return
        fi
    done
}


help() {
    echo "Usage: $0 [COMMAND | OPTION] [ARGS...]"
    echo
    echo "Commands and Options:"
    echo "  update        --update,  -u           Update the services (WILL DISABLE)"
    echo "  install       --install, -i [PKGS...] Install one or more services"
    echo "  help          --help,    -h           Show this help message"
    echo
    echo "Examples:"
    echo "  $0 update"
    echo "  $0 -u"
    echo "  $0 install service1 service2"
    echo "  $0 -i service1"
}

update(){
    check_dependencies;
}

install(){
    check_dependencies;
    
    service="$1"
    if ! [ -n $service ]; then
        help;
        exit 1;
    fi

    giturl="$(yq -r ".services[\"$service\"].giturl" $wit_yaml)"
    reponame=$(echo "$giturl" | grep -oE '[^/]+\.git$' | sed 's/\.git$//')

    if ! [ -n $giturl ]; then
        echo '[x] Service not found';
        exit 1;
    fi

    user="$service"

    # Create user if it doesn't exist
    if ! id "$user" &>/dev/null; then
        echo "[+] Creating user: $user"
        useradd -m "$user"
    else
        echo "[!] User $user already exists"
    fi

    # Ensure user is in required groups
    for group in gitdeploy docker; do
        if ! id -nG "$user" | grep -qw "$group"; then
            echo "[+] Adding $user to $group group"
            usermod -aG "$group" "$user"
        fi
    done
    
    home="/home/$user"
    
    # Install ssh config to use gitdeploy's key
    sudo -u "$user" -H ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N "" -q
    echo -e '[+] Generated keys:\n'
    sudo -u "$user" -H cat $home/.ssh/id_rsa.pub
    # Show key and wait for user input to continue
    echo -e "\nPress Enter after you added the key as a Deploy Key on Github..."
    read

    # Clone repo
    if [ ! -d "$home/$reponame/.git" ]; then
        echo "[+] Cloning $giturl"
        sudo -u "$user" -H git clone "$giturl" "$home/$reponame"
    else
        echo "[!] Repo already exists: $home/$reponame"
    fi

    # Import conf file

    dns="$reponame"
    service="$reponame.service"
    port="$(get_port)"
    name="$reponame"
    description=""

    # Load overrides from file if it exists
    conf_file="$home/$reponame/wit.conf"
    if [ -f "$conf_file" ]; then
        # shellcheck source=/dev/null
        source "$conf_file"
    else
        echo "[!] Config file not found: $conf_file. Using defaults."
    fi

    # Install and run service
    if ! [ -f "$home/.config/systemd/user/$service" ]; then
        sudo -u "$user" -H mkdir -p $home/.config/systemd/user
        sudo -u "$user" -H cp "$home/$reponame/$service" "$home/.config/systemd/user/"
    fi

    sudo -u "$user" -H systemctl --user daemon-reload
    sudo -u "$user" -H systemctl --user enable $(basename $service)
    sudo -u "$user" -H systemctl --user start $(basename $service)

    # If not running, stop
    if ! sudo -u "$user" -H systemctl --user start "$(basename "$service")"; then
        echo "[x] Failed to start the service"
        sudo -u "$user" -H systemctl --user status "$(basename "$service")"
        exit 1
    fi

    echo "[+] Service started successfully"
    
    # If running, route it through Cloudflare
    cat <<EOF | sudo tee -a /etc/cloudflare/config.yml > /dev/null
  - hostname: $dns.witjt.org
    service: http://localhost:$port
EOF

    cloudflared tunnel route dns wit-shared "$dns.witjt.org"
    systemctl restart cloudflared
}

case "$1" in
    update|-u|--update)
        update
        ;;
    install|-i|--install)
        install $2
        ;;
    help|-h|--help|"")
        help
        ;;
    *)
        echo "Unknown command: $1"
        help
        exit 1
        ;;
esac

